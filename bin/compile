#!/usr/bin/env bash

set -e

a() { sed 's/^/-----> /'; }
i() { sed 's/^/       /'; }

cd "$1"

# URLs of the Ubuntu packages to install (see main README.md for how to obtain them)
package_urls=(http://archive.ubuntu.com/ubuntu/pool/main/f/fonts-liberation/fonts-liberation_1.07.4-11_all.deb
http://archive.ubuntu.com/ubuntu/pool/universe/a/ann/libann0_1.1.2%2bdoc-7build1_amd64.deb
http://archive.ubuntu.com/ubuntu/pool/universe/g/graphviz/libcdt5_2.42.2-6ubuntu0.1_amd64.deb
http://archive.ubuntu.com/ubuntu/pool/universe/g/graphviz/libcgraph6_2.42.2-6ubuntu0.1_amd64.deb
http://archive.ubuntu.com/ubuntu/pool/universe/g/gts/libgts-0.7-5_0.7.6%2bdarcs121130-5_amd64.deb
http://archive.ubuntu.com/ubuntu/pool/universe/g/graphviz/libpathplan4_2.42.2-6ubuntu0.1_amd64.deb
http://archive.ubuntu.com/ubuntu/pool/universe/g/graphviz/libgvc6_2.42.2-6ubuntu0.1_amd64.deb
http://archive.ubuntu.com/ubuntu/pool/universe/g/graphviz/libgvpr2_2.42.2-6ubuntu0.1_amd64.deb
http://archive.ubuntu.com/ubuntu/pool/universe/g/graphviz/liblab-gamut1_2.42.2-6ubuntu0.1_amd64.deb
http://archive.ubuntu.com/ubuntu/pool/main/libx/libxmu/libxmu6_1.1.3-3_amd64.deb
http://archive.ubuntu.com/ubuntu/pool/main/libx/libxaw/libxaw7_1.0.14-1_amd64.deb
http://archive.ubuntu.com/ubuntu/pool/universe/g/graphviz/graphviz_2.42.2-6ubuntu0.1_amd64.deb
http://archive.ubuntu.com/ubuntu/pool/universe/g/gts/libgts-bin_0.7.6%2bdarcs121130-5_amd64.deb)

graphviz_version="2.42.2"

echo "Will install Graphviz version $graphviz_version" | i

# Install packages to custom directory in application slug
echo "Installing Debian packages:" | a
install_dir=.scalingo-buildpack-graphviz
mkdir -p $install_dir
for u in "${package_urls[@]}"; do
  echo "  * ${u##*/}" | i
  curl -s "$u" >pkg.deb && dpkg -x pkg.deb "$install_dir" && rm pkg.deb
done

# Location of shared libraries
libs_dir=$install_dir/usr/lib/x86_64-linux-gnu

# Create .profile.d script setting PATH and LD_LIBRARY_PATH
mkdir -p .profile.d
echo "PATH=/app/$install_dir/usr/bin:\$PATH" >.profile.d/graphviz.sh
echo "export LD_LIBRARY_PATH=/app/$libs_dir:\$LD_LIBRARY_PATH" >>.profile.d/graphviz.sh

# Run dot -c to configure plugins (creates config6a file)
LD_LIBRARY_PATH=$libs_dir "$install_dir"/usr/bin/dot -c

echo "Successfully installed Graphviz $graphviz_version" | a
echo "The binaries are in /app/$install_dir/usr/bin" | i
echo
