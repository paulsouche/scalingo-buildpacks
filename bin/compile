#!/usr/bin/env bash

set -e

a() { sed 's/^/-----> /'; }
i() { sed 's/^/       /'; }

cd "$1"

# URLs of the Ubuntu packages to install (see main README.md for how to obtain them)
package_urls=(https://apt.postgresql.org/pub/repos/apt/pool/main/libd/libdbd-pg-perl/libdbd-pg-perl_3.18.0-2.pgdg24.04%2b1_amd64.deb
http://archive.ubuntu.com/ubuntu/pool/main/libh/libhtml-tagset-perl/libhtml-tagset-perl_3.20-6_all.deb
http://archive.ubuntu.com/ubuntu/pool/main/libu/liburi-perl/liburi-perl_5.27-1_all.deb
http://archive.ubuntu.com/ubuntu/pool/main/libh/libhtml-parser-perl/libhtml-parser-perl_3.81-1build3_amd64.deb
http://archive.ubuntu.com/ubuntu/pool/main/libc/libcgi-pm-perl/libcgi-pm-perl_4.63-1_all.deb
http://archive.ubuntu.com/ubuntu/pool/main/libf/libfcgi/libfcgi0t64_2.4.2-2.1ubuntu0.24.04.1_amd64.deb
http://archive.ubuntu.com/ubuntu/pool/main/libf/libfcgi-perl/libfcgi-perl_0.82%2bds-3build2_amd64.deb
http://archive.ubuntu.com/ubuntu/pool/main/libc/libcgi-fast-perl/libcgi-fast-perl_2.17-1_all.deb
http://archive.ubuntu.com/ubuntu/pool/main/libc/libclone-perl/libclone-perl_0.46-1build3_amd64.deb
http://archive.ubuntu.com/ubuntu/pool/main/libd/libdbi-perl/libdbi-perl_1.643-4build3_amd64.deb
http://archive.ubuntu.com/ubuntu/pool/main/libe/libencode-locale-perl/libencode-locale-perl_1.05-3_all.deb
http://archive.ubuntu.com/ubuntu/pool/main/libf/libfcgi/libfcgi-bin_2.4.2-2.1ubuntu0.24.04.1_amd64.deb
http://archive.ubuntu.com/ubuntu/pool/main/libh/libhtml-template-perl/libhtml-template-perl_2.97-2_all.deb
http://archive.ubuntu.com/ubuntu/pool/main/libt/libtimedate-perl/libtimedate-perl_2.3300-2_all.deb
http://archive.ubuntu.com/ubuntu/pool/main/libh/libhttp-date-perl/libhttp-date-perl_6.06-1_all.deb
http://archive.ubuntu.com/ubuntu/pool/main/libi/libio-html-perl/libio-html-perl_1.004-3_all.deb
http://archive.ubuntu.com/ubuntu/pool/main/libl/liblwp-mediatypes-perl/liblwp-mediatypes-perl_6.04-2_all.deb
http://archive.ubuntu.com/ubuntu/pool/main/libh/libhttp-message-perl/libhttp-message-perl_6.45-1ubuntu1_all.deb
http://archive.ubuntu.com/ubuntu/pool/main/libt/libterm-readkey-perl/libterm-readkey-perl_2.38-2build4_amd64.deb
http://archive.ubuntu.com/ubuntu/pool/universe/p/postgresql-autodoc/postgresql-autodoc_1.41%2b20200921-1.1_all.deb)

echo "Will install postgresql-autodoc" | i

# Install packages to custom directory in application slug
echo "Installing Debian packages:" | a
install_dir=.scalingo-buildpack-postgresql-autodoc
mkdir -p $install_dir
for u in "${package_urls[@]}"; do
  echo "  * ${u##*/}" | i
  curl -s "$u" >pkg.deb && dpkg -x pkg.deb "$install_dir" && rm pkg.deb
done

# Create .profile.d script setting PATH, PERL5LIB and POSTGRESQL_AUTODOC_TEMPLATES_PATH
mkdir -p .profile.d
echo "PATH=/app/$install_dir/usr/bin:\$PATH" >.profile.d/postgresql-autodoc.sh
echo "export PERL5LIB=/app/$install_dir/usr/lib/x86_64-linux-gnu/perl5/5.38:\$PERL5LIB" >>.profile.d/postgresql-autodoc.sh
echo "export PERL5LIB=/app/$install_dir/usr/share/perl5:\$PERL5LIB" >>.profile.d/postgresql-autodoc.sh
echo "export POSTGRESQL_AUTODOC_TEMPLATES_PATH=/app/$install_dir/usr/share/postgresql-autodoc" >>.profile.d/postgresql-autodoc.sh

echo "Successfully installed postgresql-autodoc $postgresql_autodoc_version" | a
echo "The binaries are in /app/$install_dir/usr/bin" | i
echo
